<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- <meta http-equiv="refresh" content="15"> -->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Your Cup - SensiCup</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8f9fa;
                min-height: 100vh;
                padding-top: 80px;
            }
            
            /* Header */
            .header {
                position: fixed;
                top: 0;
                width: 100%;
                background: white;
                padding: 1rem 2rem;
                z-index: 1000;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            
            .nav {
                display: flex;
                justify-content: space-between;
                align-items: center;
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .logo {
                font-size: 1.5rem;
                font-weight: bold;
                color: #333;
                text-decoration: none;
            }
            
            .nav-links {
                display: flex;
                list-style: none;
                gap: 2rem;
            }
            
            .nav-links a {
                text-decoration: none;
                color: #333;
                font-weight: 500;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                transition: all 0.3s ease;
            }
            
            .nav-links a:hover {
                background: #333;
                color: white;
            }
            
            .nav-links a.active {
                background: #333;
                color: white;
            }
            
            /* Main Content */
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 3rem 2rem;
                text-align: center;
            }
            
            .page-title {
                font-size: 3rem;
                margin-bottom: 2rem;
                color: #333;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .status-section {
                margin: 3rem 0;
            }
            
            .status-text {
                font-size: 2rem;
                margin-bottom: 1rem;
                color: #333;
            }
            
            .status-bar {
                height: 30px;
                background: linear-gradient(to right, #ff4444, #ffaa00, #00aa00);
                border-radius: 15px;
                margin: 0 auto;
                width: 300px;
                position: relative;
            }
            
            .status-indicator {
                position: absolute;
                top: -5px;
                width: 0;
                height: 0;
                border-left: 10px solid transparent;
                border-right: 10px solid transparent;
                border-top: 20px solid #333;
                left: 75%;
                transform: translateX(-50%);
            }
            
            /* Cup Diagram Section */
            .diagram-section {
                background: white;
                border-radius: 15px;
                padding: 3rem;
                margin: 3rem 0;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            }
            
            .diagram-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 3rem;
                align-items: center;
            }
            
            .cup-diagram {
                text-align: center;
            }
            
            .cup-diagram img {
                max-width: 100%;
                height: auto;
                border-radius: 10px;
            }
            
            .sensor-info {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            
            .sensor-card {
                background: #1976d2;
                color: white;
                padding: 1rem 2rem;
                border-radius: 10px;
                text-align: left;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                position: relative;
            }
            
            .sensor-card:hover {
                background: #1565c0;
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(25, 118, 210, 0.3);
            }
            
            .sensor-card::after {
                content: 'ðŸ’¡ Click for more info';
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 0.8rem;
                opacity: 0.7;
            }
            
            /* Live Feed Section */
            .live-feed-section {
                background: white;
                border-radius: 15px;
                padding: 3rem;
                margin: 3rem 0;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            }
            
            .live-feed-title {
                font-size: 2rem;
                margin-bottom: 2rem;
                color: #333;
            }
            
            .feed-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 3rem;
                align-items: center;
            }
            
            .camera-feed {
                background: #f0f0f0;
                border-radius: 50%;
                width: 300px;
                height: 300px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #666;
                margin: 0 auto;
                border: 3px solid #ddd;
                overflow: hidden;
                position: relative;
            }
            
            .camera-feed img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 50%;
            }
            
            .camera-status {
                position: absolute;
                bottom: -30px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 0.9rem;
                color: #666;
            }
            
            .camera-status.connected {
                color: #4CAF50;
            }
            
            .camera-status.error {
                color: #f44336;
            }
            
            .particles-section {
                text-align: center;
            }
            
            .particles-title {
                font-size: 1.5rem;
                margin-bottom: 1rem;
                color: #333;
            }
            
            .particles-display {
                background: #f0f0f0;
                border-radius: 10px;
                padding: 2rem;
                color: #666;
                min-height: 200px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 2000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                animation: modalFadeIn 0.3s ease;
            }
            
            @keyframes modalFadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            .modal-content {
                background-color: #fefefe;
                margin: 5% auto;
                padding: 0;
                border-radius: 15px;
                width: 90%;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                animation: modalSlideIn 0.3s ease;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            }
            
            @keyframes modalSlideIn {
                from { transform: translateY(-50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            .modal-header {
                background: #1976d2;
                color: white;
                padding: 2rem;
                border-radius: 15px 15px 0 0;
                position: relative;
            }
            
            .modal-title {
                font-size: 2rem;
                margin: 0;
            }
            
            .modal-body {
                padding: 2rem;
                line-height: 1.6;
            }
            
            .modal-body h3 {
                color: #333;
                margin-bottom: 1rem;
            }
            
            .modal-body p {
                color: #666;
                margin-bottom: 1rem;
            }
            
            .info-table {
                width: 100%;
                border-collapse: collapse;
                margin: 1rem 0;
                background: white;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }
            
            .info-table th,
            .info-table td {
                padding: 1rem;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
            
            .info-table th {
                background: #1976d2;
                color: white;
                font-weight: 600;
            }
            
            .info-table tr:last-child td {
                border-bottom: none;
            }
            
            .close {
                position: absolute;
                right: 20px;
                top: 20px;
                color: white;
                font-size: 28px;
                font-weight: bold;
                cursor: pointer;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                background: rgba(255,255,255,0.2);
                transition: background 0.3s ease;
            }
            
            .close:hover {
                background: rgba(255,255,255,0.3);
            }
            
            .citation {
                font-size: 0.9rem;
                color: #888;
                font-style: italic;
                margin-top: 1rem;
                padding: 1rem;
                background: #f9f9f9;
                border-radius: 8px;
                border-left: 4px solid #1976d2;
            }
            
            /* Footer */
            .footer {
                background: #333;
                color: white;
                text-align: center;
                padding: 2rem;
                margin-top: 5rem;
            }
            
            .footer-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 2rem;
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .footer-section h4 {
                margin-bottom: 1rem;
            }
            
            .footer-section p {
                color: #ccc;
                font-size: 0.9rem;
            }
            
            .footer-section h5 a {
                color: #BEBEBE;
                text-decoration: none;
                font-weight: thin;
            }
            
            .footer-section h5 a:hover {
                text-decoration: underline;
                color: #B5D5F4;
                font-weight: thin;
            }
            
            /* Responsive Design */
            @media (max-width: 768px) {
                .diagram-grid,
                .feed-grid {
                    grid-template-columns: 1fr;
                    gap: 2rem;
                }
                
                .nav-links {
                    display: none;
                }
                
                .page-title {
                    font-size: 2rem;
                }
                
                .camera-feed {
                    width: 250px;
                    height: 250px;
                }
                
                .footer-grid {
                    grid-template-columns: 1fr;
                }
                
                .modal-content {
                    width: 95%;
                    margin: 10% auto;
                }
                
                .sensor-card::after {
                    display: none;
                }
            }
        </style>
    </head>

    <body>
        <!-- Header -->
        <header class="header">
            <nav class="nav">
                <a href="/" class="logo">SensiCup</a>
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href="/your-cup" class="active">Your Cup</a></li>
                    <li><a href="/database">Database</a></li>
                    <li><a href="/contact">Contact Us</a></li>
                </ul>
            </nav>
        </header>

        <div class="container">
            <h1 class="page-title">Your SensiCup Dashboard</h1>
            
            <!-- Status Section - Always Visible -->
            <div class="status-section">
                <p class="status-text">Your water is <span id="water-status">Good</span></p>
                <div class="status-bar">
                    <div class="status-indicator"></div>
                </div>
            </div>
            
            <!-- Diagram Section - Always Visible -->
            <div class="diagram-section">
                <div class="diagram-grid">
                    <div class="cup-diagram">
                        <div style="background: #f0f0f0; min-height: 400px; width: 100%; display: flex; align-items: center; justify-content: center; border-radius: 10px; color: #666;">
                            <!-- Fallback content if image doesn't load -->
                            <div>SensiCup Diagram</div>
                        </div>
                    </div>
                    <div class="sensor-info">
                        <div class="sensor-card" onclick="openModal('ph-modal')">pH Level: <span id="ph-display">7.2</span></div>
                        <div class="sensor-card" onclick="openModal('tds-modal')">TDS Level: <span id="tds-display">245 ppm</span></div>
                        <div class="sensor-card" onclick="openModal('salinity-modal')">Salinity Level: <span id="salinity-display">0.02%</span></div>
                        <div class="sensor-card">Temperature: <span id="temperature-display">25.0Â°C</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Live Feed Section - Always Visible -->
            <div class="live-feed-section">
                <h2 class="live-feed-title">Water Image in Real Time</h2>
                <div class="feed-grid">
                    <div class="camera-feed">
                        <img id="live-video" alt="Live Water Feed" />
                        <div id="camera-status" class="camera-status">Loading...</div>
                    </div>
                    <div class="particles-section">
                        <h3 class="particles-title">Particles Found</h3>
                        <div class="particles-display">
                            <div>
                                <p>âœ“ No harmful particles detected</p>
                                <p>ðŸ”¬ Cleanliness Score: <span id="cleanliness-display">85</span>/100</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- pH Modal -->
        <div id="ph-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="close" onclick="closeModal('ph-modal')">&times;</span>
                    <h2 class="modal-title">What Does My Water's pH Level Mean?</h2>
                </div>
                <div class="modal-body">
                    <p>In simple terms, pH level in water indicates how acidic or basic (also called alkaline) the water is. It is a scale from 0 to 14, where 7 is neutral. A pH below 7 is acidic, and a pH above 7 is basic. While a pH of around 6.5 to 8.5 is often considered safe for drinking water, extreme pH levels can affect taste and potentially cause corrosion or scaling in pipes. Please check the chart given to see if the pH level is outside the range of safe drinking water for reference.</p>
                    
                    <table class="info-table">
                        <thead>
                            <tr>
                                <th>pH Range</th>
                                <th>Water Quality</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>0 - 6.4</td><td>Acidic (Poor)</td></tr>
                            <tr><td>6.5 - 8.5</td><td>Safe (Good)</td></tr>
                            <tr><td>8.6 - 14</td><td>Basic (Poor)</td></tr>
                        </tbody>
                    </table>
                    
                    <div class="citation">
                        Vanstone, Emma. "What Is the pH Scale?" Science Experiments for Kids, 16 Oct. 2023, www.science-sparks.com/what-is-the-ph-scale.
                    </div>
                </div>
            </div>
        </div>

        <!-- TDS Modal -->
        <div id="tds-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="close" onclick="closeModal('tds-modal')">&times;</span>
                    <h2 class="modal-title">What Does My Water's TDS Level Mean?</h2>
                </div>
                <div class="modal-body">
                    <p>TDS (Total Dissolved Solids) will help measure your water quality by seeing the total amount of dissolved materials you can drink and materials you cannot such as salts, minerals, metals, etc. If your TDS level is under 300 milligrams per liter, then your water quality is excellent and most of the dissolved materials you have in your water is consumable! Please check the graph to see if the TDS level is your water is above 300 milligrams per liter for reference.</p>
                    
                    <table class="info-table">
                        <thead>
                            <tr>
                                <th>Level of TDS (milligrams per litre)</th>
                                <th>Rating</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Less than 300</td><td>Excellent</td></tr>
                            <tr><td>300 - 600</td><td>Good</td></tr>
                            <tr><td>600 - 900</td><td>Fair</td></tr>
                            <tr><td>900 - 1,200</td><td>Poor</td></tr>
                            <tr><td>Above 1,200</td><td>Unacceptable</td></tr>
                        </tbody>
                    </table>
                    
                    <div class="citation">
                        "Taste of Water with Different TDS Concentrations," https://cdn.who.int/media/docs/default-source/wash-documents/wash-chemicals/tds.pdf?sfvrsn=3e6d651e_4
                    </div>
                </div>
            </div>
        </div>

        <!-- Salinity Modal -->
        <div id="salinity-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="close" onclick="closeModal('salinity-modal')">&times;</span>
                    <h2 class="modal-title">What Does My Water's Salinity Level Mean?</h2>
                </div>
                <div class="modal-body">
                    <p>Salinity levels in your water measure how much salt there is in your water. This will help you understand how much salinity can influence the drinking water you have as it strongly contributes to the content of the water you drink. If the salinity level in your water is 600 milligrams per liter or less, then your water quality is excellent with low salinity and you can drink it! For the higher salinity levels, the least likely it is healthy for you to drink it. Please check the chart given to see if the salinity level is higher than 600 milligrams per liter for reference.</p>
                    
                    <table class="info-table">
                        <thead>
                            <tr>
                                <th>Salinity (mg/L)</th>
                                <th>Quality</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>0 - 600</td><td>Good</td></tr>
                            <tr><td>600 - 900</td><td>Fair</td></tr>
                            <tr><td>900 - 1,200</td><td>Poor</td></tr>
                            <tr><td>> 1,200</td><td>Unacceptable (unpalatable)</td></tr>
                        </tbody>
                    </table>
                    
                    <div class="citation">
                        "River Water Salinity Impact on Drinking Water Treatment Plant Performance Using Artificial Neural Network." Journal of Engineering, vol. 25, no. 8, July 2019, pp. 149â€“59. https://doi.org/10.31026/j.eng.2019.08.10.
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-grid">
                <div class="footer-section">
                    <h4>SensiCup</h4>
                    <h5><a href="/">Home</a></h5>
                    <h5><a href="/contact">Contact Us</a></h5>
                </div>
                <div class="footer-section">
                    <h4>Information</h4>
                    <h5><a href="/your-cup">Your Cup</a></h5>
                    <h5><a href="/database">Database</a></h5>
                </div>
            </div>
        </footer>

        <!-- Socket.IO and JavaScript -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
        <script>
            let socket;
            let imageRefreshInterval;
            let imageLoadAttempts = 0;
            const MAX_LOAD_ATTEMPTS = 5;
            const currentCupId = 'DEFAULT_CUP'; // Since we removed cup code input
            
            // Auto-connect on page load
            window.addEventListener('load', function() {
                connectToWebSocket(currentCupId);
                loadInitialData();
                initializeCameraFeed();
            });
            
            function loadInitialData() {
                // Load some default values immediately
                updateSensorDisplay({
                    ph: 7.2,
                    tds: 245,
                    temperature: 25.0,
                    salinity: 0.02,
                    cleanliness_score: 85
                });
            }
            
            function initializeCameraFeed() {
                const liveVideo = document.getElementById('live-video');
                const statusElement = document.getElementById('camera-status');
                
                function loadImage() {
                    const timestamp = new Date().getTime();
                    const imageUrl = `/static/sensicup.jpg?t=${timestamp}`;
                    
                    console.log('Attempting to load image:', imageUrl);
                    
                    // Create a new image object to test loading
                    const testImage = new Image();
                    
                    testImage.onload = function() {
                        console.log('Image loaded successfully');
                        liveVideo.src = imageUrl;
                        statusElement.textContent = 'Connected';
                        statusElement.className = 'camera-status connected';
                        imageLoadAttempts = 0; // Reset attempts counter
                    };
                    
                    testImage.onerror = function() {
                        console.log('Image load failed, attempt:', imageLoadAttempts + 1);
                        imageLoadAttempts++;
                        
                        if (imageLoadAttempts >= MAX_LOAD_ATTEMPTS) {
                            console.log('Max load attempts reached, showing error');
                            liveVideo.style.display = 'none';
                            statusElement.textContent = 'Camera Not Available';
                            statusElement.className = 'camera-status error';
                            
                            // Show placeholder text in camera feed
                            const cameraFeed = document.querySelector('.camera-feed');
                            cameraFeed.innerHTML = '<div>Camera Not Available</div><div id="camera-status" class="camera-status error">Camera Not Available</div>';
                        } else {
                            statusElement.textContent = `Connecting... (${imageLoadAttempts}/${MAX_LOAD_ATTEMPTS})`;
                            statusElement.className = 'camera-status';
                        }
                    };
                    
                    // Start the test load
                    testImage.src = imageUrl;
                }
                
                // Initial load
                loadImage();
                
                // Set up interval for refreshing
                imageRefreshInterval = setInterval(loadImage, 2000);
            }
            
            function connectToWebSocket(cupCode) {
                // Connect to your Flask SocketIO server
                socket = io();
                
                socket.on('connect', function() {
                    console.log('Connected to server');
                    // Request latest data for this cup
                    socket.emit('get_latest_data', {'cup_id': cupCode});
                });

                // Listen for real-time sensor updates
                socket.on('sensor_update', function(data) {
                    console.log('Received sensor data:', data);
                    updateSensorDisplay(data);
                });
                
                socket.on('disconnect', function() {
                    console.log('Disconnected from server');
                });

                socket.on('connect_error', function(error) {
                    console.log('Connection error:', error);
                    // Keep showing last known values
                });
            }
            
            function updateSensorDisplay(data) {
                console.log('Updating display with:', data);
                
                // Update pH
                if (data.ph !== undefined && data.ph !== null) {
                    document.getElementById('ph-display').textContent = parseFloat(data.ph).toFixed(1);
                }
                
                // Update TDS
                if (data.tds !== undefined && data.tds !== null) {
                    document.getElementById('tds-display').textContent = Math.round(parseFloat(data.tds)) + ' ppm';
                }
                
                // Update Temperature
                if (data.temperature !== undefined && data.temperature !== null) {
                    document.getElementById('temperature-display').textContent = parseFloat(data.temperature).toFixed(1) + 'Â°C';
                }
                
                // Update Salinity - convert from decimal to percentage if needed
                if (data.salinity !== undefined && data.salinity !== null) {
                    let salinity = parseFloat(data.salinity);
                    // If salinity is less than 1, assume it's already a percentage
                    if (salinity < 1) {
                        document.getElementById('salinity-display').textContent = (salinity).toFixed(2) + ' ppt';
                    } else {
                        document.getElementById('salinity-display').textContent = salinity.toFixed(2) + ' ppt';
                    }
                }
                
                // Update Cleanliness
                if (data.cleanliness_score !== undefined && data.cleanliness_score !== null) {
                    document.getElementById('cleanliness-display').textContent = Math.round(parseFloat(data.cleanliness_score));
                }
                
                // Update overall water status based on the values
                updateWaterStatus(data);
            }
            
            function updateWaterStatus(data) {
                let status = 'Good';
                let statusIndicatorPosition = 75; // Default position (Good = 75%)
                
                // Simple logic to determine overall water quality
                let issues = 0;
                
                // Check pH (6.5-8.5 is good)
                const ph = parseFloat(data.ph);
                if (ph < 6.5 || ph > 8.5) {
                    issues++;
                    console.log('pH issue detected:', ph);
                }
                
                // Check TDS (under 300 is excellent, under 600 is good)
                const tds = parseFloat(data.tds);
                if (tds > 600) {
                    issues++;
                    console.log('TDS issue detected:', tds);
                } else if (tds > 300) {
                    issues += 0.5;
                    console.log('TDS fair quality:', tds);
                }
                
                // Check cleanliness score
                const cleanliness = parseFloat(data.cleanliness_score);
                if (cleanliness < 60) {
                    issues++;
                    console.log('Cleanliness issue detected:', cleanliness);
                } else if (cleanliness < 80) {
                    issues += 0.5;
                    console.log('Cleanliness fair quality:', cleanliness);
                }
                
                // Determine status
                if (issues === 0) {
                    status = 'Excellent';
                    statusIndicatorPosition = 90;
                } else if (issues <= 1) {
                    status = 'Good';
                    statusIndicatorPosition = 75;
                } else if (issues <= 2) {
                    status = 'Fair';
                    statusIndicatorPosition = 50;
                } else {
                    status = 'Poor';
                    statusIndicatorPosition = 25;
                }
                
                // Update the display
                document.getElementById('water-status').textContent = status;
                document.querySelector('.status-indicator').style.left = statusIndicatorPosition + '%';
                console.log('Overall status:', status, 'Issues:', issues);
            }

            // Modal functions
            function openModal(modalId) {
                document.getElementById(modalId).style.display = 'block';
            }

            function closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            // Close modal when clicking outside of it
            window.onclick = function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }
            
            // Clean up intervals when page unloads
            window.addEventListener('beforeunload', function() {
                if (imageRefreshInterval) {
                    clearInterval(imageRefreshInterval);
                }
            });
        </script>
    </body>
</html>