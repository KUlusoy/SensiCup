<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Database - SensiCup</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f8f9fa;
                min-height: 100vh;
                padding-top: 80px;
            }
            
            /* Header */
            .header {
                position: fixed;
                top: 0;
                width: 100%;
                background: white;
                padding: 1rem 2rem;
                z-index: 1000;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            
            .nav {
                display: flex;
                justify-content: space-between;
                align-items: center;
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .logo {
                font-size: 1.5rem;
                font-weight: bold;
                color: #333;
                text-decoration: none;
            }
            
            .nav-links {
                display: flex;
                list-style: none;
                gap: 2rem;
            }
            
            .nav-links a {
                text-decoration: none;
                color: #333;
                font-weight: 500;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                transition: all 0.3s ease;
            }
            
            .nav-links a:hover {
                background: #333;
                color: white;
            }
            
            .nav-links a.active {
                background: #333;
                color: white;
            }
            
            /* Main Content */
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 3rem 2rem;
            }
            
            .upload-section {
                background: white;
                border-radius: 15px;
                padding: 3rem;
                margin-bottom: 3rem;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 3rem;
                align-items: flex-start;
            }
            
            .submit-section {
                padding-right: 2rem;
                border-right: 2px solid #f0f0f0;
            }
            
            .upload-photos-section {
                padding-left: 2rem;
            }
            
            .section-title {
                font-size: 1.5rem;
                margin-bottom: 1rem;
                color: #333;
                font-weight: 600;
            }
            
            .upload-content h2 {
                font-size: 2rem;
                margin-bottom: 1rem;
                color: #333;
            }
            
            .upload-content p {
                color: #666;
                line-height: 1.6;
                margin-bottom: 2rem;
            }
            
            .upload-form {
                margin-top: 1rem;
            }
            
            .upload-form input[type="text"] {
                width: 100%;
                padding: 15px;
                border: 2px solid #ddd;
                border-radius: 10px;
                font-size: 1rem;
                margin-bottom: 1rem;
                outline: none;
                transition: border-color 0.3s ease;
            }
            
            .upload-form input[type="text"]:focus {
                border-color: #1976d2;
            }
            
            .submit-btn {
                width: 100%;
                background: #333;
                color: white;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1rem;
                cursor: pointer;
                transition: background 0.3s ease;
            }
            
            .submit-btn:hover {
                background: #555;
            }
            
            .upload-area {
                background: #f5f5f5;
                border: 2px dashed #ccc;
                border-radius: 10px;
                padding: 2rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s ease;
                min-height: 150px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                margin-top: 1rem;
            }
            
            .upload-area:hover {
                background: #ebebeb;
                border-color: #999;
            }
            
            .upload-area.dragover {
                background: #e3f2fd;
                border-color: #1976d2;
            }
            
            .upload-area i {
                font-size: 2rem;
                color: #999;
                margin-bottom: 1rem;
            }
            
            .upload-area p {
                color: #666;
                margin: 0;
                font-size: 0.9rem;
            }
            
            .upload-area input[type="file"] {
                display: none;
            }
            
            .uploaded-files {
                margin-top: 1rem;
                text-align: left;
            }
            
            .file-item {
                background: #e8f5e8;
                padding: 0.5rem 1rem;
                border-radius: 5px;
                margin-bottom: 0.5rem;
                font-size: 0.9rem;
                color: #333;
            }
            
            /* Database Section */
            .database-section {
                margin-top: 4rem;
            }
            
            .database-section h2 {
                font-size: 2rem;
                margin-bottom: 2rem;
                color: #333;
            }
            
            .database-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 2rem;
            }
            
            .database-card {
                background: white;
                border-radius: 15px;
                padding: 2rem;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                text-align: center;
                position: relative;
                cursor: pointer; /* Make the card clickable */
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

            .database-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            }
            
            .database-card-content {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100%;
            }

            .database-card-buttons {
                display: flex;
                justify-content: space-around;
                margin-top: 1rem;
            }
            
            .delete-btn, .download-btn {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: #ff4444;
                color: white;
                border: none;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                cursor: pointer;
                font-size: 1rem;
                transition: background 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .delete-btn {
                background: #ff4444;
                right: 1rem;
            }

            .download-btn {
                background: #1976d2;
                right: 4.5rem;
                font-size: 1.1rem;
            }

            .delete-btn:hover { background: #cc0000; }
            .download-btn:hover { background: #1565c0; }

            .database-image-container {
                height: 200px;
                border-radius: 10px;
                margin-bottom: 1rem;
                overflow: hidden;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #f0f0f0;
            }

            .database-image-container img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .database-image-container .placeholder {
                color: #666;
                font-style: italic;
            }
            
            .database-card h3 {
                margin-bottom: 0.5rem;
                color: #333;
            }
            
            .database-card p {
                color: #666;
                font-size: 0.9rem;
            }

            /* Lightbox/Modal */
            .lightbox {
                display: none;
                position: fixed;
                z-index: 2000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0,0,0,0.9);
                justify-content: center;
                align-items: center;
            }

            .lightbox-content {
                position: relative;
                max-width: 80%;
                max-height: 80%;
                display: flex;
                align-items: center;
            }

            .lightbox-content img {
                max-width: 80%;
                max-height: 80%;
                border-radius: 10px;
                display: block;
                margin: auto;
            }

            .lightbox-prev, .lightbox-next {
                cursor: pointer;
                position: absolute
                top: 50%;
                transform: translateY(-50%);
                color: white;
                font-size: 3rem;
                font-weight: bold;
                transition: 0.3s;
                user-select: none;
                padding: 1rem;
                background-color: rgba(0,0,0,0.5);
                border-radius: 50%;
            }

            .lightbox-close {
                cursor: pointer;
                position: absolute;
                top: calc(1rem + 20px);
                right: 1rem;
                color: white;
                font-weight: bold;
                transition: 0.3s;
                user-select: none;
                background-color: transparent;
                border: 2px solid white;

                font-size: 1.5rem; /* Make the 'x' smaller */
                padding: 0.5rem; /* Use equal padding to create a square button */
                width: 2.5rem; /* Explicitly set width and height for perfect circle */
                height: 2.5rem;
                border-radius: 50%; /* Make it a circle */
                display: flex; /* Use flexbox to center the 'x' */
                align-items: center;
                justify-content: center;
                transform: translateY(-25px);
            }

            .lightbox-prev { left: 2rem; }
            .lightbox-next { right: 2rem; }

            .lightbox-close:hover,
            .lightbox-prev:hover,
            .lightbox-next:hover {
                background-color: rgba(255,255,255,0.2);
            }

            /* Footer */
            .footer {
                background: #333;
                color: white;
                text-align: center;
                padding: 2rem;
                margin-top: 5rem;
            }
            
            .footer-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 2rem;
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .footer-section h4 {
                margin-bottom: 1rem;
            }
            
            .footer-section p {
                color: #ccc;
                font-size: 0.9rem;
            }
            
            .footer-section h5 a {
                color: #BEBEBE;
                text-decoration: none;
                font-weight: thin;
            }
            
            .footer-section h5 a:hover {
                text-decoration: underline;
                color: #B5D5F4;
                font-weight: thin;
            }
            
            /* Responsive Design */
            @media (max-width: 768px) {
                .upload-section {
                    grid-template-columns: 1fr;
                    gap: 2rem;
                }
                
                .submit-section {
                    border-right: none;
                    border-bottom: 2px solid #f0f0f0;
                    padding-right: 0;
                    padding-bottom: 2rem;
                }
                
                .upload-photos-section {
                    padding-left: 0;
                    padding-top: 2rem;
                }
                
                .nav-links {
                    display: none;
                }
                
                .database-grid {
                    grid-template-columns: 1fr;
                }
                
                .footer-grid {
                    grid-template-columns: 1fr;
                }
                .lightbox-prev, .lightbox-next {
                    font-size: 2rem;
                    padding: 0.5rem;
                }
                .lightbox-close {
                    top: 1rem;
                    right: 1rem;
                }
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <header class="header">
            <nav class="nav">
                <a href="/" class="logo">SensiCup</a>
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href="/your-cup">Your Cup</a></li>
                    <li><a href="/database" class="active">Database</a></li>
                    <li><a href="/contact">Contact Us</a></li>
                </ul>
            </nav>
        </header>

        <div class="container">
            <div class="upload-section">
                <div class="submit-section">
                    <h2>Submit Database Information</h2>
                    <p>Currently, datasets that label particles in the water to monitor water quality are scarce. By adding your photos, you can contribute to crowdsourcing and creating collections of photos for others to download, which is helpful to make machine learning models better or the science community in general.</p>
                    
                    <form class="upload-form" action="/submit-photo" method="POST" enctype="multipart/form-data" id="databaseForm">
                        <input type="text" placeholder="Database name" name="database_name" required>
                        <input type="text" placeholder="Add a description" name="description" required>
                        <button type="submit" class="submit-btn">Create Database</button>
                    </form>
                </div>
                
                <div class="upload-photos-section">
                    <h3 class="section-title">Upload Photos</h3>
                    <p style="color: #666; margin-bottom: 1rem;">Select or drag photos to upload to your database</p>
                    
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" name="photos" multiple accept="image/*" form="databaseForm">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                        <p>Click or drag photos here</p>
                        <div class="uploaded-files" id="uploadedFiles"></div>
                    </div>
                </div>
            </div>
            
            <div class="database-section">
                <h2>Your Databases</h2>
                <div class="database-grid" id="databaseGrid">
                    <!-- Databases will be loaded from backend -->
                    {% if databases %}
                        {% for database in databases %}
                        <div class="database-card" data-id="{{ database.id }}">
                            <div class="database-card-buttons">
                                <form action="/delete-database" method="POST" style="display: inline;" onclick="event.stopPropagation()">
                                    <input type="hidden" name="database_id" value="{{ database.id }}">
                                    <button type="submit" class="delete-btn" title="Delete database">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </form>
                                <a href="/download_database/{{ database.id }}" class="download-btn" title="Download database" onclick="event.stopPropagation()">
                                    <i class="fa-solid fa-download"></i>
                                </a>
                            </div>
                            <div class="database-image-container">
                                {% if database.first_photo_path %}
                                    <img src="{{ url_for('display_photo', filename=database.first_photo_path) }}" alt="Cover image for {{ database.name }}">
                                {% else %}
                                    <p class="placeholder">No photos uploaded</p>
                                {% endif %}
                            </div>
                            <h3>{{ database.name }}</h3>
                            <p>{{ database.description }}</p>
                            <p><strong>{{ database.photo_count }} photos</strong></p>
                            <p><strong>Created: {{ database.date_created }}</strong></p>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="grid-column: 1 / -1; text-align: center; color: #666; font-style: italic;">No databases created yet. Create your first database above!</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- The Lightbox Modal -->
        <div id="lightbox" class="lightbox">
            <span class="lightbox-close" id="closeBtn">&times;</span>
            <div class="lightbox-content">
                <a class="lightbox-prev" id="prevBtn">&#10094;</a>
                <img id="lightbox-image" src="" alt="">
                <a class="lightbox-next" id="nextBtn">&#10095;</a>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-grid">
                <div class="footer-section">
                    <h4>SensiCup</h4>
                    <h5><a href="/">Home</a></h5>
                    <h5><a href="/contact">Contact Us</a></h5>
                </div>
                <div class="footer-section">
                    <h4>Information</h4>
                    <h5><a href="/your-cup">Your Cup</a></h5>
                    <h5><a href="/database">Database</a></h5>
                </div>
            </div>
        </footer>

        <script>
            const uploadArea = document.querySelector('.upload-area');
            const fileInput = document.getElementById('fileInput');
            const uploadedFiles = document.getElementById('uploadedFiles');
            const databaseGrid = document.getElementById('databaseGrid');
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const closeBtn = document.getElementById('closeBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            let currentPhotos = [];
            let currentPhotoIndex = 0;

            // Handle file input change
            fileInput.addEventListener('change', function(e) {
                displayFiles(e.target.files);
            });

            // Handle drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                fileInput.files = files;
                displayFiles(files);
            });

            function displayFiles(files) {
                uploadedFiles.innerHTML = '';
                for (let i = 0; i < files.length; i++) {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.textContent = files[i].name;
                    uploadedFiles.appendChild(fileItem);
                }
            }
            
            // Handle opening the lightbox when a database card is clicked
            databaseGrid.addEventListener('click', async function(e) {
                const card = e.target.closest('.database-card');
                if (card) {
                    const databaseId = card.dataset.id;
                    try {
                        const response = await fetch(`/get_photos/${databaseId}`);
                        const photoPaths = await response.json();
                        if (photoPaths.length > 0) {
                            currentPhotos = photoPaths.map(path => `/display_photo/${path}`);
                            currentPhotoIndex = 0;
                            lightbox.style.display = "flex";
                            updateLightboxImage();
                        } else {
                            // Optionally, show a message that there are no photos
                            alert("This database has no photos to display.");
                        }
                    } catch (error) {
                        console.error('Error fetching photos:', error);
                    }
                }
            });

            // Update the image in the lightbox
            function updateLightboxImage() {
                if (currentPhotos.length > 0) {
                    lightboxImage.src = currentPhotos[currentPhotoIndex];
                }
            }

            // Navigate to the previous image
            prevBtn.addEventListener('click', function() {
                if (currentPhotos.length > 0) {
                    currentPhotoIndex = (currentPhotoIndex - 1 + currentPhotos.length) % currentPhotos.length;
                    updateLightboxImage();
                }
            });

            // Navigate to the next image
            nextBtn.addEventListener('click', function() {
                if (currentPhotos.length > 0) {
                    currentPhotoIndex = (currentPhotoIndex + 1) % currentPhotos.length;
                    updateLightboxImage();
                }
            });

            // Close the lightbox
            closeBtn.addEventListener('click', function() {
                lightbox.style.display = "none";
            });

            // Close the lightbox by clicking outside the image
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    lightbox.style.display = "none";
                }
            });

            // Add keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (lightbox.style.display === "flex") {
                    if (e.key === "ArrowLeft") {
                        prevBtn.click();
                    } else if (e.key === "ArrowRight") {
                        nextBtn.click();
                    } else if (e.key === "Escape") {
                        closeBtn.click();
                    }
                }
            });

        </script>
    </body>
</html>